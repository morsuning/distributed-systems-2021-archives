# note

## LEC 1 Introduction

什么是分布式系统？多台协作计算机、大型网站的存储、MapReduce、点对点共享等，许多关键基础设施是分布式的

人们为什么要构建分布式系统？通过并行性增加容量，通过复制容忍错误，将计算物理放置在靠近外部实体的位置，通过隔离实现安全；但是，分布式系统有许多并发部分，需要进行复杂的交互，必须应对部分失败，很难挖掘性能潜力

大目标：隐藏分布复杂性的抽象。在课程中，有几个主题会反复出现

主题：容错性
数千台服务器，庞大的网络 -> 总有东西会出故障
我们希望将这些故障对应用程序隐藏起来。
我们通常需要：
可用性 – 即使发生故障，应用程序也能继续运行
可恢复性 – 当故障修复后，应用程序能够恢复正常
核心思想：服务器复制。
如果一台服务器崩溃，可以使用其他服务器继续处理
非常难以实现
服务器可能没有崩溃，但由于某些原因无法访问
但仍然在为客户端提供服务

主题：一致性
通用基础设施需要明确的行为定义。
例如：“Get(k) 返回最近一次 Put(k,v) 的值。”
实现良好的行为很难！
很难保持“副本”服务器的一致性

主题：性能
目标：可扩展的吞吐量
Nx 台服务器 -> 通过并行 CPU、磁盘、网络，实现 Nx 的总吞吐量
随着 N 的增加，扩展变得更加困难：
负载不平衡，慢速节点，N 中最慢的延迟
不可并行的代码：初始化，交互
来自共享资源的瓶颈，例如网络
一些性能问题并不能通过扩展轻松解决
例如：单个用户请求的快速响应时间
例如：所有用户都想更新同一数据
这些通常需要更好的设计，而不仅仅是增加计算机数量

主题：容错性、一致性和性能是对立的
强容错性需要通信
例如，将数据发送到备份服务器
强一致性也需要通信
例如，Get() 必须检查最近的 Put() 操作。
许多设计只提供弱一致性，以提高速度。
例如，Get() 不会返回最新的 Put() 结果！
这对应用程序开发者来说可能很痛苦，但可能是个不错的折中方案
在一致性和性能的权衡上，有许多可能的设计点！

主题：实现
RPC、线程、并发控制

## LEC 2 Go的RPC通信和线程

## LEC 3 GFS

为什么分布式存储很难？
- 高性能 -> 数据分片到许多服务器
- 许多服务器 -> 持续不断的故障
- 容错性 -> 数据复制
- 数据复制 -> 潜在的不一致性
- 更好的**一致性** -> 低性能

我们对一致性有何期望？
- 理想模型：行为与单一服务器相同
    - 服务器使用磁盘存储
    - 服务器一次执行一个客户端操作（即使操作是并发的）
    - 读取操作反映之前的写入操作
        - 即使服务器崩溃并重启
    - 因此：
        - 假设 C1 和 C2 同时写入，在写入完成后，C3 和 C4 读取。它们可能会看到什么？
            - C1: Wx1
            - C2: Wx2
            - C3: Rx?
            - C4: Rx?
            - 答案：要么是1，要么是2，但必须看到相同的值
    - 这是一个“强一致性”模型
    - 但单一服务器的容错性很差

为了容错进行的复制使得强一致性变得复杂

- 一个简单但有问题的复制方案：
    - 两个副本服务器，S1 和 S2
    - 客户端将写操作同时发送给两台服务器
    - 客户端从任意一台服务器读取
    - 在我们的例子中，C1 和 C2 的写入消息可能会以不同的顺序到达两台副本服务器
        - 如果 C3 读取 S1，可能会看到 x=1
        - 如果 C4 读取 S2，可能会看到 x=2
    - 或者，如果 S1 收到写操作，但客户端在将写操作发送到 S2 之前崩溃了怎么办？
    - 这就不是强一致性了！
- 更好的**一致性**通常需要通信以确保副本保持同步——这可能很慢！
- 在性能和一致性之间有许多可能的权衡

GFS设计要点
1. 具有持续监控、错误检测、容错和自动恢复
2. 可处理大量数以十亿计的小文件
3. 采用追加写的方式，不用文件内的随机写，无需在客户端缓存数据块
4. 共同设计文件系统和应用程序API
    - 如支持多客户端同时追加写
    - 简单的API

GFS总结
- 案例研究：性能、容错性、一致性，专为 MapReduce 应用设计
- 优点：
    - 作为通用基础设施的全局集群文件系统
    - 将命名（主服务器）与存储（块服务器）分离
    - 通过分片实现并行吞吐量
    - 使用大文件/大块减少开销
    - 通过主节点顺序处理写操作
    - 通过租约机制防止块服务器主节点的脑裂
- 不足之处：
    - 单一主服务器的性能问题
        - 内存和 CPU 不足
    - 块服务器对小文件的处理效率不高
    - 缺乏对主服务器副本的自动故障转移
    - 可能一致性设置得过于宽松

## LEC 4 Primary/Backup Replication for Fault Tolerance

复制可以处理哪些类型的故障？
单个副本的“fail-stop”故障
风扇停止工作，CPU 过热并自行关闭
有人被复制品的电源线或网线绊倒
软件注意到磁盘空间不足并停止

两种主要的复制方法：
1. 状态转移
主副本执行服务,主节点将新状态发送到备份节点
2. 复制状态机
客户端将操作发送到主节点，主序列并发送到备份，所有副本执行所有操作，如果启动状态相同，相同的操作，相同的顺序，确定性的，然后相同的最终状态

状态转移更简单，但状态可能很大，通过网络传输很慢

复制状态机通常会产生较少的网络流量，与状态相比，操作通常规模较小，但要正确执行很复杂

大问题：
复制什么状态？
主库是否必须等待备份？
何时切换到备份？
切换时是否可见异常情况？
如何加快替换备份的速度？

## LEC 5 Raft

