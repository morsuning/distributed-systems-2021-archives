6.824 2021 第19讲：比特币

比特币：一个点对点电子现金系统，作者Satoshi Nakamoto，2008年

为什么读这篇论文？
- 与拜占庭参与者达成共识
  - 类似SUNDR：签名操作日志，和分叉
    - 如果同意日志内容，就同意状态
  - 不同于SUNDR
    - 以去中心化方式同意分叉
- 比大多数系统更分布式 - 去中心化，点对点
  - 参与者的身份未知，甚至数量未知
- 共识方案新颖且非常有趣
- 比特币的成功是一个大惊喜

技术挑战是什么？
- 公然伪造（容易解决）
- 双重支付（困难，比特币做得相当好）
- 盗窃（困难，比特币不是特别强）

账本记录中有什么？
- pub(user1)：新所有者的公钥
- hash(prev)：这个比特币先前交易记录的哈希
- sig(user2)：由先前所有者私钥对交易的签名
- （比特币更复杂：金额（小数）、多个输入/输出，...）

交易示例：
- Y拥有一个比特币，之前由X给：
  - T6: pub(X), ...
  - T7: pub(Y), hash(T6), sig(X)
- Y从Z购买一个汉堡并用这个比特币支付
  - Z向Y发送公钥
  - Y创建新交易并签名
  - T8: pub(Z), hash(T7), sig(Y)
- Y向Z发送交易记录
- Z验证：
  - T8的sig(Y)对应T7的pub(Y)
- Z给Y汉堡

只有交易存在，比特币本身不存在
- Z的"余额"是Z知道私钥的未花费交易集合
- 比特币的"身份"是其最近交易的（哈希）

除了所有者之外，有人可以花费比特币吗？
- 需要当前所有者的私钥来签名下一个交易
- 危险：攻击者可以窃取Z的私钥，例如从PC、智能手机或在线交易所
  - 这是一个实际问题，很难很好地解决

在这个方案中，比特币的所有者可以花费它两次吗？
- Y为同一个比特币创建两个交易：Y->Z, Y->Q
  - 两个都有hash(T7)
- Y向Z和Q显示不同的交易
- 两个交易看起来都很好，包括签名和哈希
- 现在Z和Q都会给Y汉堡

为什么双重支付可能？
- 因为Z和Q不知道交易的完整集合和顺序

我们需要什么？
- 发布所有交易的日志
- 确保每个人都看到相同的日志（以相同顺序！）
- 确保Y不能取消发布交易
- 结果：
  - Z将看到Y->Z在Y->Q之前，并将接受Y->Z
  - Q将看到Y->Z在Y->Q之前，并将拒绝Y->Q
  - 一个"公共账本"
- 如何创建这样的账本？
  - "中本聪共识"：最长链规则
  - 概率保证，但出来时是一个令人惊讶的结果！

比特币区块链
- 目标：就交易日志达成共识以防止双重支付
- 区块链包含所有比特币的交易
- 许多对等节点
  - 每个都有整个链的完整副本
  - 每个都有与其他几个对等节点的TCP连接 - "网格覆盖"
  - 新块通过TCP转发广播到所有对等节点
  - 提议的交易也广播到所有对等节点
- 每个块：
  - hash(prevblock)
  - 交易集合
  - "nonce"（可以是任何东西，我们将看到）
  - 当前时间（挂钟时间戳）
- 每10分钟一个新块，包含自上一个块以来的交易
- 收款人不接受交易直到它在区块链中

谁创建每个新块？
- 这是通过"工作量证明"的"挖矿"
- 要求：hash(block)有N个前导零
- 每个对等节点尝试随机nonce值直到成功
- 尝试一个nonce很快，但大多数nonce不会成功
  - 就像掷无数面硬币直到正面朝上
  - 每次掷骰都有独立的（小）成功机会
  - 挖矿一个块*不是*特定固定量的工作
- 一个CPU可能需要几个月来创建一个块
- 但成千上万的对等节点在为此工作
- 使得预期到第一个被发现的时间约为10分钟
  - 尽管方差很大
- 获胜者向所有对等节点广播新块
- 工作量证明解决女巫攻击问题 - 你的CPU必须是真实的才能获胜

Y->Z交易如何与区块链一起工作？
- 开始：所有对等节点知道...<-B5
  - 并且正在挖矿块B6（尝试不同的nonce）
- Y向对等节点发送Y->Z交易，这些对等节点广播它
- 对等节点缓冲交易直到B6计算完成
- 听到Y->Z的对等节点将其包含在下一个块中
- 所以最终...<-B5<-B6<-B7，其中B7包含Y->Z

问：B6可能有两个*不同*的后继吗？
答：是的：
  1) 两个对等节点大约同时找到nonce，或
  2) 网络慢，第二个块在第一个被知道之前找到
- 两个同时的块将不同
  - 挖矿者知道略有不同的新交易集合，等等
- 如果有两个后继，区块链暂时分叉
  - 对等节点在他们先听到的任何块上工作
  - 但如果他们意识到一个更长的链，就切换到它

分叉如何解决？
- 每个对等节点最初相信它看到的任何新块
- 尝试创建后继
- 如果更多看到Bx比By，更多将为Bx挖矿，
  - 所以Bx后继可能先被创建
- 即使恰好一半对一半，一个分叉可能先被扩展
  - 因为挖矿时间有显著方差
- 对等节点一旦看到它就切换到挖掘最长分叉，强化共识
- 被放弃分叉中的交易怎么办？
  - 大多数将在两个分叉中
  - 但一些可能只在被放弃的分叉中 - 出现，然后消失！

如果Y同时发送Y->Z和Y->Q会发生什么？
- 即Y尝试双重支付
- 正确的对等节点将接受他们先看到的，忽略第二个
- 因此下一个块将有一个但不是两个

如果Y告诉一些对等节点Y->Z，其他对等节点Y->Q？
- 也许使用网络DoS来防止任一个完全广播
- 也许会有一个分叉：B6<-BZ和B6<-BQ

因此：
- 由于分叉，暂时的双重支付是可能的
- 但分叉的一方或另一方极有可能很快消失
- 因此如果Z看到Y->Z后面有几个块，
  - 它不太可能被包含Y->Q的不同分叉超越
- 如果Z销售高价值物品，Z应该在发货前等待几个块
- 如果Z销售便宜的东西，也许只需等待一些对等节点看到Y->Z并验证它（但不在块中）

攻击者可以修改区块链中间的现有块吗？
- 并告诉新启动的对等节点关于修改的块？
- 例如删除攻击者比特币的第一次花费？
- 不：那么下一个块中的"prev"哈希将是错误的，对等节点会检测到

攻击者可以从旧块开始分叉，用Y->Q而不是Y->Z吗？
- 是的 - 但分叉必须更长以便对等节点接受它
- 因为攻击者的分叉从主分叉后面开始，
  - 攻击者必须比其他对等节点总和更快地挖矿块
- 只有一个CPU，即使创建几个块也需要几个月
  - 那时主链会长得多
  - 没有对等节点会切换到攻击者更短的链
- 如果攻击者拥有比所有诚实比特币对等节点更多的CPU能力 - 那么攻击者可以创建最长分叉，
  - 每个人都会切换到它，允许攻击者双重支付

为什么挖矿方案有效？
- 在所有参与者中随机选择谁能选择扩展哪个分叉
  - 由CPU能力加权
- 如果大多数参与者是诚实的，他们将强化对最长分叉的共识
- 如果攻击者控制大部分CPU能力，它可以迫使诚实对等节点从真实链切换到攻击者创建的链

为什么挖矿？
- 块中的第一笔交易支付给挖矿者
  - 挖矿者获得6.25比特币（当前）
  - 它将其公钥放在第一笔交易中
  - 这是人们运营比特币对等节点的激励
- 后果：军备竞赛
  - 挖矿的专用硬件以获胜
  - 协作的挖矿者池
  - 能源浪费
- "自私挖矿"攻击
  - 即使攻击者控制较少（> 1/3），它也可以执行"自私挖矿"攻击
  - 一群挖矿者在找到下一个块后保密
  - 当网络其余部分赶上时，池发布已扣留的块
  - 使池的私有分叉成为公共分叉

验证检查：
- 对等节点，新交易：
  - 没有其他交易花费相同的先前交易
  - 签名由先前交易中公钥的私钥签名
  - 然后将交易添加到下一个要挖矿的块的交易列表
- 对等节点，新块：
  - 哈希值有足够的前导零（即nonce正确，证明工作）
  - 先前块哈希存在
  - 块中所有交易都有效
  - 如果比当前最长链更长，对等节点切换到新链
- Z：
  - （一些客户端依赖对等节点执行上述检查，一些不）
  - Y->Z在一个块中
  - Z的公钥/地址在交易中
  - 链中还有几个更多的块
- （还必须检查其他东西，很多细节）

问：10分钟很烦人；能短得多吗？

问：如果很多挖矿者加入，块的创建率会更高吗？

问：为什么比特币扩展最长链？为什么不是其他规则？

问：交易是匿名的吗？

问：如果我偷了比特币，花掉它们安全吗？

问：比特币可以被伪造吗，即创建一个完全假的比特币？

问：对手拥有世界上大部分CPU能力能做什么？
  - 可以通过分叉双重支付和取消支付
  - 不能偷别人的比特币
  - 可以阻止交易进入链

问：如果块格式需要改变怎么办？
  - 特别是如果新格式不能被以前的软件版本接受？
  - "硬分叉"

问：对等节点如何找到彼此？

问：如果一个对等节点被骗只与腐败的对等节点交谈怎么办？
  - 如果它与一个好的对等节点和许多串通的坏对等节点交谈怎么办？

问：一个全新的对等节点可能被骗完全使用错误的链吗？
  - 如果一个对等节点在几年断开后重新加入怎么办？
  - 断开连接几天？

问：一台机器挖矿你可能多富有？

问：为什么挖矿奖励随时间减少有意义？

问：固定数量的比特币是个问题吗？
  - 如果真实经济在增长（或缩小）怎么办？

问：为什么比特币有价值？
  - 例如人们似乎愿意支付每比特币8,935美元（2020年5月5日）。
  - 2021年5月9日：56,812美元

问：比特币能很好地扩展吗？
  - 在CPU时间方面？
    - 显然CPU限制到4,000 tps（签名检查）
    - 比Visa多但比现金少
  - 在存储方面？
    - 你需要查看非常旧的块吗？
    - 你需要传输整个区块链吗？
    - Merkle树：块头vs交易数据。
  - 在网络流量方面？
    - 每十分钟几兆字节（一个块）
  - 遗憾的是，最大块大小限制在几兆字节

问：比特币可以只是一个没有新货币的账本吗？
  - 例如使用美元作为货币？
  - 因为货币部分相当尴尬。
  - （结算...挖矿激励...）

设计中的弱点？
- 很糟糕它既是一个新货币又是一个支付系统
- 交易确认至少需要10分钟，高信心需要60分钟
- 广播限制性能，可能是一个攻击点
- 最大块大小加上10分钟限制每秒最大交易数
- 易受多数攻击
- 工作量证明浪费CPU时间、电力
- 不太匿名
- 太匿名 - 非法使用可能引发法律响应
- 用户难以保护私钥

关键思想：区块链
- 公共约定的账本是一个很棒的想法
- 去中心化可能很好
- 挖矿是在开放系统中避免女巫攻击的聪明方法，
  - 并确保大多数块由良性对等节点创建

---- 参考文献 ----

比特币SoK: https://www.ieee-security.org/TC/SP2015/papers-archived/6949a104.pdf
脚本语言: https://en.bitcoin.it/wiki/Script
https://www.oreilly.com/library/view/mastering-bitcoin/9781491902639/ch08.html