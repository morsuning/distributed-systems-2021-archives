VMware FT 常见问题

问：引言说在物理服务器上确保确定性执行比在虚拟机上更困难。为什么会这样？

答：在VM上确保确定性更容易，因为hypervisor模拟和控制了硬件的许多方面，这些方面可能在主服务器和备份执行之间有所不同，例如中断传递的精确时机。

问：什么是hypervisor？

答：hypervisor是虚拟机系统的一部分；它与虚拟机监视器（VMM）相同。hypervisor模拟一台计算机，客户操作系统（和应用程序）在模拟的计算机内执行。客户机运行的模拟通常被称为虚拟机。在本文中，主服务器和备份是在虚拟机内运行的客户机，FT是实现每个虚拟机的hypervisor的一部分。

问：GFS和VMware FT都提供容错。我们应该如何思考何时一个比另一个更好？

答：FT复制计算；你可以用它来透明地为任何现有网络服务器添加容错。FT提供相当严格的一致性，对服务器和客户端是透明的。例如，你可以使用FT使现有的邮件服务器容错。相比之下，GFS只为存储提供容错。因为GFS专门针对特定的简单服务（存储），它的复制比FT更高效。例如，GFS不需要导致中断在所有副本上的完全相同的指令处发生。GFS通常只是实现完整容错服务的更大系统的一部分。例如，VMware FT本身依赖于主服务器和备份共享的容错存储服务（图1中的共享磁盘），你可以使用类似GFS的东西来实现（尽管在详细级别上GFS对FT来说不是完全合适的东西）。

问：3.4节的反弹缓冲区如何帮助避免竞争？

答：问题出现在当网络数据包或请求的磁盘块到达主服务器并需要复制到主服务器内存时。没有FT的情况下，相关硬件在软件执行时将数据复制到内存中。客户机指令可以在DMA期间读取该内存；取决于精确的时机，客户机可能看到或看不到DMA的数据（这就是竞争）。如果主服务器和备份都这样做，但由于轻微的时机差异一个在DMA后读取，另一个在DMA前读取，那将很糟糕。在这种情况下它们会分歧。

FT通过在主服务器或备份执行时不复制到客户机内存来避免这个问题。FT首先将网络数据包或磁盘块复制到主服务器无法访问的私有"反弹缓冲区"。当第一次复制完成时，FT hypervisor中断主服务器以便它不执行。FT记录它中断主服务器的点（与任何中断一样）。然后FT将反弹缓冲区复制到主服务器的内存，之后允许主服务器继续执行。FT在日志通道上将数据发送给备份。备份的FT在与主服务器被中断相同的指令处中断备份，在备份不执行时将数据复制到备份的内存，然后恢复备份。

效果是网络数据包或磁盘块在主服务器和备份中完全相同的时间出现，所以无论它们何时读取内存，两者都看到相同的数据。

问：什么是"共享存储上的原子测试和设置操作"？

答：系统使用网络磁盘服务器，由主服务器和备份共享（图1中的"共享磁盘"）。那个网络磁盘服务器有一个"测试和设置服务"。测试和设置服务维护一个最初设置为false的标志。如果主服务器或备份认为另一台服务器死了，因此它应该自己接管，它首先向磁盘服务器发送一个测试和设置操作。服务器大致执行这段代码：

  test-and-set() {
    acquire_lock()
    if flag == true:
      release_lock()
      return false
    else:
      flag = true
      release_lock()
      return true

主服务器（或备份）只有在测试和设置返回true时才接管（"上线"）。

更高层次的视图是，如果主服务器和备份失去与对方的网络联系，我们只希望其中一个上线。危险是，如果两者都正常运行且网络故障，两者都可能上线并发展出脑裂。如果主服务器或备份中只有一个能与磁盘服务器通信，那么只有那台服务器会上线。但如果两者都能与磁盘服务器通信怎么办？然后网络磁盘服务器充当平局打破者；测试和设置只对第一次调用返回true。

问：遵循输出规则会损失多少性能？

答：表2提供了一些见解。通过遵循输出规则，传输率降低了，但不是巨大地。

问：如果应用程序调用随机数生成器怎么办？那不会在主服务器和备份上产生不同结果并导致执行分歧吗？

答：主服务器和备份将从它们的随机数生成器获得相同的数字。所有随机性来源都由hypervisor控制。例如，应用程序可能使用当前时间，或硬件周期计数器，或精确的中断时间作为随机性来源。在所有三种情况下，hypervisor在主服务器和备份上拦截相关指令，并确保它们产生相同的值。

问：创建者如何确定他们捕获了所有可能形式的非确定性？

答：我的猜测如下。作者在一个许多人很好地理解VM hypervisor、微处理器和客户操作系统内部的公司工作，并且会意识到许多陷阱。对于VM-FT具体来说，作者利用了先前项目（确定性重放）的日志和重放支持，该项目必须已经处理了非确定性的来源。我假设确定性重放的设计者进行了广泛的测试，并获得了VM-FT作者使用的非确定性来源的经验。

问：如果主服务器在向外部世界发送输出后立即失败怎么办？

答：备份可能在接管后重复输出，所以它被生成两次。这种重复对网络和磁盘I/O不是问题。如果输出是网络数据包，那么接收客户端的TCP软件将自动丢弃重复。如果输出事件是磁盘I/O，磁盘I/O是幂等的（都向相同位置写入相同数据，并且没有中间I/O）。

问：3.4节谈到主服务器在故障时未完成的磁盘I/O；它说"相反，我们在备份VM的上线过程中重新发出未决的I/O"。未决的I/O位于/存储在哪里，重新发出需要回到多远？

答：论文谈论的是有日志条目指示I/O已开始但没有指示完成的磁盘I/O。这些是必须在备份上重新启动的I/O操作。当I/O完成时，I/O设备生成I/O完成中断。所以，如果日志中缺少I/O完成中断，那么备份重新启动I/O。如果日志中有I/O完成中断，那么不需要重新启动I/O。

问：备份FT如何能够在备份指令流中的特定点传递中断（即在主服务器上中断最初发生的相同指令处）？

答：许多CPU支持一个特性（"性能计数器"），让FT VMM告诉CPU一个指令数量，CPU将在那个数量的指令后中断到FT VMM。

问：这个系统有多安全？

答：作者假设主服务器和备份遵循协议并且不是恶意的（例如，攻击者没有危害hypervisor）。系统无法处理被危害的hypervisor。另一方面，hypervisor可能可以防御恶意或有缺陷的客户操作系统和应用程序。

问：只处理故障停止故障是合理的吗？其他类型的故障是什么？

答：这是合理的，因为许多现实世界的故障本质上是故障停止，例如许多网络和电源故障。做得比这更好需要处理看起来正确运行但实际上计算错误结果的计算机；在最坏的情况下，也许故障是恶意攻击者的结果。这个更大的非故障停止故障类别通常被称为"拜占庭"。有方法处理拜占庭故障，我们将在课程结束时涉及，但6.824的大部分是关于故障停止故障的。