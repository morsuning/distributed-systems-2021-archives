FAQ FaRM

问：目前使用FaRM的一些系统是什么？

答：只有FaRM。它没有在生产中使用；它是一个最近的研究原型。我怀疑它将影响未来的设计，也许本身会发展成一个生产系统。

问：为什么微软研究院发布这个？Google、Facebook、Yahoo等的研究分支也是如此。他们总是揭示这些新系统的设计？这肯定对技术进步更好，但似乎（至少在短期内）符合他们的最大利益来保持这些设计的秘密。

答：这些公司只发布他们编写的软件的一小部分论文。他们发布的一个原因是这些系统部分由具有学术背景的人（即有博士学位的人）开发，他们觉得他们生活使命的一部分是帮助世界理解他们发明的新思想。他们为自己的工作感到自豪，希望人们欣赏它。另一个原因是这样的论文可能帮助公司吸引顶尖人才，因为论文显示那里正在进行智力上有趣的工作。

问：FaRM真的标志着分布式系统中一致性/可用性必要妥协的结束吗？

答：我怀疑不是。例如，如果你愿意做非事务性单方面RDMA读和写，你可以做到比FaRM完整事务快5倍。也许今天很少有人想要那5倍的额外性能，但也许有一天会。在另一个维度上，对地理分布数据的事务有相当大的兴趣，对此FaRM似乎不太相关。

问：这篇论文并没有真正关注FaRM的负面。FaRM的一些最大限制是什么？

答：这里有一些猜测。数据必须适合RAM。如果事务冲突很多，OCC会产生很多中止。事务API（在他们的NSDI 2014论文中描述）使用起来很尴尬，因为回复在回调中返回。应用程序代码必须紧密交错执行应用程序事务和轮询RDMA NIC队列和来自其他计算机的消息。应用程序代码在最终会中止的事务执行期间可能看到不一致性。例如，如果事务读取一个大对象同时提交事务正在覆盖该对象。风险是如果应用程序不是防御性编写，它可能会崩溃。应用程序可能不能很容易使用自己的线程，因为FaRM将线程固定到核心，并使用所有核心。当然，FaRM是一个旨在探索新思想的研究原型。它不是一个供一般使用的完成产品。如果人们继续这条工作线，我们可能最终看到FaRM的后代有更少的粗糙边缘。

问：什么是NIC？

答：网络接口卡--将计算机连接到网络的硬件。

问：什么是RDMA？单方面RDMA？

答：RDMA是一些现代NIC（网络接口卡）中实现的特殊功能。NIC寻找通过网络到达的特殊命令数据包，并自己执行命令（不将数据包给CPU）。命令指定内存操作，如将值写入地址或从地址读取并通过网络发回值。此外，RDMA NIC允许应用程序代码直接与NIC硬件通信以发送特殊RDMA命令数据包，并在表示接收NIC已执行命令的"硬件ACK"数据包到达时得到通知。

"单方面"指的是一台计算机中的应用程序代码使用这些RDMA NIC直接读写另一台计算机中的内存而不涉及另一台计算机的CPU的情况。FaRM在第4节/图4中的"验证"阶段只使用单方面读。

FaRM有时使用RDMA作为实现类似RPC方案的快速方式来与接收计算机上运行的软件通信。发送方使用RDMA将请求消息写入接收方FaRM软件正在轮询（定期检查）的内存区域；接收方以相同方式发送回复。FaRM的"锁定"阶段以这种方式使用RDMA。

RDMA的好处是速度。单方面RDMA读或写只需1/18微秒（图2），而传统RPC可能需要10微秒。即使FaRM使用RDMA进行消息传递也比传统RPC快得多：接收方中的用户空间代码频繁轮询传入的NIC队列以快速看到新消息，而不是涉及中断和用户/内核转换。

问：为什么基于RDMA的FaRM RPC比传统RPC更快？

答：传统RPC要求应用程序对本地内核进行系统调用，内核要求本地NIC发送数据包。在接收计算机上，NIC将数据包写入内存中的队列并中断接收计算机的内核。内核将数据包复制到用户空间并使应用程序看到它。接收应用程序做相反的操作来发送回复（对内核的系统调用，内核与NIC通信，另一端的NIC中断其内核，等等）。这一点是每个RPC执行大量代码，而且不是很快速。

问：FaRM的大部分性能来自硬件。软件设计在哪些方面对性能有贡献？

答：确实，FaRM快的一个原因是硬件快。但硬件已经存在多年，但没有人想出如何将所有部分组合在一起真正利用硬件的潜力。FaRM做得这么好的一个原因是他们同时在优化网络、持久存储和CPU使用方面投入了大量努力；许多先前的系统只优化了一个而不是全部。一个具体的设计点是FaRM对许多交互使用快速单方面RDMA（而不是较慢的完整RPC）。

问：其他系统使用UPS（不间断电源，带电池）来实现快速但持久的存储吗？

答：这个想法很老；例如Harp复制文件服务在1990年代初使用它。许多存储系统以相关方式使用电池（例如在RAID控制器中）以避免等待磁盘写入。然而，FaRM使用的电池设置类型并不特别常见，所以必须通用的软件不能依赖它。如果你配置自己的硬件有电池，那么修改你的Raft（或k/v服务器）来利用你的电池是有意义的。

问：如果没有电池备份RAM，FaRM设计还有意义吗？

答：我不确定FaRM在没有非易失性RAM的情况下会工作，因为那样单方面日志写入（例如图4中的COMMIT-BACKUP）不会在电源故障中持久。你可以修改FaRM以便在返回前将所有日志更新写入SSD，但那时它的性能会低得多。SSD写入需要大约100微秒，而FaRM的单方面RDMA写入非易失性RAM只需要几微秒。

问：DRAM不就是本质上易失的吗？

答：作者通过使用UPS在电源故障时将内存写入SSD使RAM"非易失化"。但这确实不是完全非易失的，因为如果计算机因除电源故障外的任何其他原因崩溃，失败机器内存的内容会丢失。这就是为什么他们在几个机器间复制区域并有快速恢复协议的原因。

问：如果电源即将故障，FaRM服务器将RAM复制到SSD。他们可以使用机械硬盘而不是SSD吗？

答：他们使用SSD因为它们快。他们可以使用硬盘而不改变设计。然而，在停电期间向磁盘写入数据会更长时间，这将需要更大的电池。也许使用硬盘节省的钱会被电池增加的成本抵消。

问：FaRM中主服务器、备份服务器和配置管理器之间有什么区别？为什么有三个角色？

答：数据分片在许多主/备份集中。备份的目的是存储分片数据和日志的副本，以防主服务器故障。主服务器执行对分片中数据的所有读和写，而备份服务器只执行写（为了保持它们的数据副本与主服务器的副本相同）。只有一个配置管理器。它跟踪哪些主服务器和备份服务器活着，并跟踪数据如何在它们之间分片。在高层次上，这种安排类似于GFS，GFS也将数据分片在许多主/备份集中，也有一个跟踪数据存储位置的主服务器。

问：FaRM在小规模有意义吗？

答：我认为只有在你需要支持每秒大量事务时FaRM才有意义。如果你只需要每秒几千事务，你可以使用现成的成熟技术如MySQL。你可能建立一个比作者90机器系统小得多的FaRM系统。但FaRM没有意义，除非你分片和复制数据，这意味着你需要至少四个数据服务器（两个分片，每个分片两个服务器）加上几台机器用于ZooKeeper（尽管你可能可以在四台机器上运行ZooKeeper）。那么你可能有一个成本约10,000美元的系统，每秒可以执行几百万简单事务，这相当不错。

问：第3节似乎说单个事务的读可能看到不一致的数据。这似乎不像是可序列化的！

答：Farm只保证提交的事务的可序列化。如果事务看到第3节谈论的那种不一致性，FaRM将中止事务。应用程序必须处理不一致性，在它们不应该崩溃的意义上，这样它们可以进展到请求提交，以便FaRM可以中止它们。

问：FaRM如何确保事务的读是一致的？如果事务读取正在被不同事务修改的对象会发生什么？

答：这里有两个危险。首先，对于一个大对象，读者可能在并发事务写入之前读取对象的前半部分，在并发事务写入之后读取后半部分，这可能导致读取程序崩溃。第二，如果读事务可能与并发写事务不可序列化，就不能允许它提交。

基于我对作者之前NSDI 2014论文的阅读，第一个问题的解决方案是每个对象的每个缓存行都有一个版本号，单缓存行RDMA读和写是原子的。读事务的FaRM库获取对象的所有缓存行，然后检查它们是否都有相同的版本号。如果是，库将对象的副本给应用程序；如果不是，库通过RDMA再次读取它。第二个问题由第4节描述的FaRM验证方案解决。在VALIDATE步骤中，如果另一个事务在我们的事务开始后写入我们事务读过的对象，我们的事务将被中止。

问：日志截断如何工作？什么时候可以删除日志条目？如果一个条目被截断调用删除，所有先前的条目也被删除吗？

答：TC告诉主服务器和备份服务器在TC看到它们在日志中有COMMIT-PRIMARY或COMMIT-BACKUP后删除事务的日志条目。为了恢复将知道事务完成了尽管截断，第62页提到主服务器即使在截断后也记住已完成的事务ID。截断意味着截断点之前的所有日志条目被删除；这有效是因为每个主/备份对每个TC有单独的日志。

问：在COMMIT-BACKUP期间是否可能发生中止，也许由于硬件故障？

答：我相信是。如果其中一个备份没有响应，并且TC崩溃，那么事务可能在恢复期间中止的可能性。

问：由于这是一个乐观协议，当许多事务需要修改同一个对象时它会受到影响吗？

答：当多个事务同时修改同一个对象时，其中一些将在图4的LOCK阶段看到锁已经被持有。每个这样的事务将中止（它们不等待锁被释放），并从头重新开始。如果这种情况发生很多，性能确实会受影响。但是，对于作者测量的应用程序，FaRM获得极好的性能。很可能一个原因是他们的应用程序冲突事务相对较少，因此中止不多。

问：图7显示当操作数量超过每微秒120个时延迟显著增加。为什么？

答：我怀疑限制是服务器总共只能处理大约每秒1.4亿操作。如果客户端发送操作比那快，其中一些必须等待；这种等待导致延迟增加。

问：什么是垂直Paxos？

答：这是一种Paxos协议的风格，其中外部主服务器执行重新配置，而Paxos组可以在重新配置期间继续执行操作（详见https://lamport.azurewebsites.net/pubs/vertical-paxos.pdf）。在FaRM论文中，作者松散地使用术语"垂直Paxos"来表示配置管理由外部服务（Zookeeper和CM）完成，事务的写处理用标准主/备份协议完成。