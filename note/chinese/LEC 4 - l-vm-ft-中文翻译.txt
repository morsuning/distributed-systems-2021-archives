6.824 2021 第4讲：主备复制

今天的内容
  用于容错的主备复制
  VMware FT案例研究，这个思想的极端版本

主题是（仍然）容错
  提供可用性
  尽管有服务器和网络故障
  使用复制

复制能处理什么类型的故障？
  单个副本的"故障停止"故障
    风扇停止工作，CPU过热并自动关闭
    有人绊倒副本的电源线或网络电缆
    软件注意到磁盘空间不足并停止
  可能不是硬件缺陷或软件错误或人为配置错误
    通常不是故障停止
    可能是相关的（即导致所有副本同时崩溃）
    但是，有时可以被检测到（例如，校验和）
  地震或全市停电怎么办？
    只有在副本物理分离的情况下

复制值得N倍的费用吗？

两种主要的复制方法：
  状态转移
    主副本执行服务
    主副本将[新]状态发送给备份
  复制状态机
    客户端向主副本发送操作，
      主副本排序并发送给备份
    所有副本执行所有操作
    如果起始状态相同，
      相同的操作，
      相同的顺序，
      确定性的，
      那么结束状态相同。

状态转移更简单
  但状态可能很大，通过网络传输很慢

复制状态机通常产生较少的网络流量
  操作通常比状态小
  但很难做对
  VM-FT使用复制状态机，实验2/3/4也使用

大问题：
  要复制什么状态？
  主副本必须等待备份吗？
  何时切换到备份？
  切换时是否有异常可见？
  如何将替代备份提升到最新状态？

我们希望副本在什么级别上相同？
  应用程序状态，例如数据库的表？
    GFS就是这样工作的
    可以高效；主副本只向备份发送高级操作
    应用程序代码（服务器）必须理解容错，例如转发操作流
  机器级别，例如寄存器和RAM内容？
    可能让我们复制任何现有服务器而无需修改！
    需要转发机器事件（中断、DMA等）
    需要"机器"修改来发送/接收事件流...

今天的论文（VMware FT）复制机器级别状态
  透明：可以运行任何现有的操作系统和服务器软件！
  对客户端看起来像单个服务器

概述
  [图：应用、操作系统、VM-FT底层、磁盘服务器、网络、客户端]
  术语：
    hypervisor == monitor == VMM（虚拟机监视器）
    操作系统+应用程序是在虚拟机内运行的"客户机"
  两台机器，主服务器和备份
  主服务器通过网络将所有外部事件（客户端数据包等）发送给备份
    "日志通道"，携带日志条目
  通常，备份的输出被FT抑制
  如果任何一个无法通过网络与另一个通信
    "上线"并提供唯一服务
    如果主服务器上线，它停止向备份发送日志条目

VMM模拟本地磁盘接口
  但实际存储在网络服务器上
  处理方式很像客户端：
    通常只有主服务器与磁盘服务器通信（备份的FT丢弃）
    如果备份上线，它与磁盘服务器通信
  外部磁盘使创建新备份更快（不必复制主服务器的磁盘）

主服务器何时必须向备份发送信息？
  任何时候发生可能导致它们执行分歧的事情。
  任何不是执行指令的确定性结果的事情。

FT必须处理什么分歧来源？
  大多数指令在主服务器和备份上执行相同。
    只要内存+寄存器相同，
      我们通过归纳假设这一点。
  来自外部世界的输入——只是网络数据包。
    这些显示为DMA的数据加上中断。
  中断的时机。
  不是状态函数的指令，例如读取当前时间。
  不是多核竞争，因为只有单处理器。

为什么分歧会是灾难？
  因为备份上的状态与主服务器上的状态不同，
    如果主服务器随后失败，客户端会看到不一致。
  例子：GFS租约过期
    想象我们在复制GFS主服务器
    块服务器必须在60秒租约过期前发送"请续订"消息
    时钟中断驱动主服务器的时间概念
    假设块服务器在60秒左右发送"请续订"
    在主服务器上，时钟中断在请求到达后发生。
      主服务器副本续订租约，到相同的块服务器。
    在备份上，时钟中断在请求前发生。
      备份副本过期租约。
    如果主服务器失败，备份接管，它会认为
      没有租约，并授予不同的块服务器。
      然后两个块服务器将有相同块的租约。
  所以：备份必须看到相同的事件，
    以相同的顺序，
    在指令流中的相同点。

每个日志条目：指令号、类型、数据。

FT处理定时器中断
  目标：主服务器和备份应该在指令流中的相同点看到中断
  主服务器：
    FT处理定时器中断
    FT从CPU读取指令号
    FT在日志通道上发送"指令X处的定时器中断"
    FT向主服务器传递中断，并恢复它
    （这依赖于CPU支持在第X条指令后中断）
  备份：
    忽略自己的定时器硬件
    FT在备份到达指令X之前看到日志条目
    FT告诉CPU在指令X处中断（到FT）
    FT向备份模拟定时器中断

FT处理网络数据包到达（输入）
  主服务器：
    FT告诉NIC将数据包数据复制到FT的私有"反弹缓冲区"
    在某个点NIC进行DMA，然后中断
    FT获得中断
    FT暂停主服务器
    FT将反弹缓冲区复制到主服务器的内存
    FT在主服务器中模拟NIC中断
    FT将数据包数据和指令号发送给备份
  备份：
    FT从日志流获取数据和指令号
    FT告诉CPU在指令X处中断（到FT）
    FT将数据复制到备份内存，在备份中模拟NIC中断

为什么用反弹缓冲区？
  我们希望数据在主服务器和备份执行中的完全相同点出现在内存中。
  否则它们可能分歧。

注意备份必须滞后一个日志条目
  假设主服务器在指令X后获得中断或输入
  如果备份已经执行过X，它不能正确处理输入
  所以备份FT在看到第一个日志条目之前根本不能开始执行
    然后它只执行到该日志条目中的指令号
    并在恢复备份之前等待下一个日志条目

例子：非确定性指令
  一些指令即使主服务器/备份有相同状态也产生不同结果
  例如，读取当前时间或周期计数或处理器序列号
  主服务器：
    FT设置CPU如果主服务器执行这样的指令就中断
    FT执行指令并记录结果
    将结果和指令号发送给备份
  备份：
    FT读取日志条目，设置在指令号处中断
    FT然后提供主服务器获得的值

输出（发送网络数据包）怎么办？
  主服务器和备份都执行输出指令
  主服务器的FT实际执行输出
  备份的FT丢弃输出

输出例子：DB服务器
  客户端可以发送"增加"请求
    DB增加存储的值，用新值回复
  所以：
    [图]
    假设服务器的值开始为10
    网络将客户端请求传递给主服务器上的FT
    主服务器的FT在日志通道上发送给备份
    FTs将请求传递给主服务器和备份
    主服务器执行，设置值为11，发送"11"回复，FT实际发送回复
    备份执行，设置值为11，发送"11"回复，FT丢弃
    客户端得到一个"11"响应，如预期

但是等等：
  假设主服务器在发送回复后立即崩溃
    所以客户端得到"11"回复
  并且日志通道丢弃带有客户端请求的日志条目
    主服务器死了，所以不会重新发送
  备份上线
    但它的内存中有值"10"！
  现在客户端发送另一个增加请求
    它会再次得到"11"，而不是"12"
  糟糕

解决方案：输出规则（2.2节）
  在主服务器发送输出之前，
  必须等待备份确认所有先前的日志条目

再次，使用输出规则：
  [图]
  主服务器：
    接收客户端"增加"请求
    在日志通道上发送客户端请求
    即将向客户端发送"11"回复
    首先等待备份确认先前的日志条目
    然后向客户端发送"11"回复
  假设主服务器在这个序列中的某个点崩溃
  如果在主服务器收到备份确认之前
    也许备份没有看到客户端请求，没有增加
    但主服务器也不会回复
  如果在主服务器收到备份确认之后
    那么客户端可能看到"11"回复
    但备份保证收到带有客户端请求的日志条目
    所以备份将增加到11

输出规则是件大事
  在所有复制系统中以某种形式出现
  对性能的严重约束
  应用程序特定巧思的领域
    例如，也许主服务器在回复只读操作前不需要等待
  FT没有应用程序级别的知识，必须是保守的

问：如果主服务器在收到备份确认后立即崩溃，
   但在主服务器发出输出之前怎么办？
   这意味着输出永远不会产生吗？

答：当主服务器失败且备份上线时会发生什么。
   备份从主服务器获得了一些日志条目。
   备份继续执行这些日志条目，输出被丢弃。
   在最后一个日志条目后，备份上线——停止丢弃输出
   在我们的例子中，最后一个日志条目是客户端请求的到达
   所以在客户端请求到达后，客户端将开始发出输出
   因此它将向客户端发出回复

问：但如果主服务器在发出输出*之后*崩溃怎么办？
   备份会*第二次*发出输出吗？

答：是的。
   对TCP没问题，因为接收者忽略重复的序列号。
   对磁盘写入没问题，因为备份将向相同块号写入相同数据。

切换时的重复输出在复制系统中很常见
  客户端需要保持足够状态来忽略重复
  或者设计成重复是无害的

问：FT处理网络分区吗——它会遭受脑裂吗？
   例如，如果主服务器和备份都认为对方宕机了。
   它们都会上线吗？

答：磁盘服务器打破僵局。
   磁盘服务器支持原子测试和设置。
   如果主服务器或备份认为对方死了，尝试测试和设置。
   如果只有一个存活，它将赢得测试和设置并上线。
   如果两者都尝试，一个将失败，并停止。

磁盘服务器可能是单点故障
  如果磁盘服务器宕机，服务就宕机
  他们可能想到一个复制的磁盘服务器

问：为什么他们不支持多核？

性能（表1）
  FT/非FT：令人印象深刻！
    几乎没有减速
  日志带宽
    直接反映磁盘读取率+网络输入率
    my-sql为18 Mbit/s
  这些数字对我来说似乎很低
    应用程序可以以至少400兆位/秒读取磁盘
    所以他们的应用程序不是很磁盘密集

什么时候FT可能有吸引力？
  关键但低强度的服务，例如名称服务器。
  软件不方便修改的服务。

高吞吐量服务的复制怎么办？
  人们使用应用程序级别的复制状态机，例如数据库。
    状态只是数据库，而不是所有的内存+磁盘。
    事件是DB命令（put或get），而不是数据包和中断。
  结果：更细粒度的同步，更少的开销。
  GFS使用应用程序级别的复制，实验2等也使用

总结：
  主备复制
    VM-FT：干净的例子
  如何在没有单点故障的情况下处理分区？
    下一讲
  如何获得更好的性能？
    应用程序级别的复制状态机
----

VMware KB（#1013428）谈论多CPU支持。VM-FT可能已经从复制状态机方法切换到状态转移方法，但不清楚这是否真实。

http://www.wooditwork.com/2014/08/26/whats-new-vsphere-6-0-fault-tolerance/

http://www-mount.ece.umn.edu/~jjyi/MoBS/2007/program/01C-Xu.pdf

http://web.eecs.umich.edu/~nsatish/abstracts/ASPLOS-10-Respec.html