GFS 常见问题

问：为什么原子记录追加是至少一次，而不是恰好一次？

3.1节第7步说，如果写入在某个副本上失败，客户端会重试写入。这将导致数据在非故障副本上被多次追加。一个不同的设计可能可以检测重复的客户端请求，尽管有任意的故障（例如，在原始请求和客户端重试之间主服务器故障）。你将在实验3中实现这样的设计，这将在复杂性和性能上付出相当大的代价。

问：应用程序如何知道块的哪些部分由填充和重复记录组成？

答：要检测填充，应用程序可以在有效记录的开头放置一个可预测的魔术数字，或者包含一个校验和，该校验和只有在记录有效时才可能有效。应用程序可以通过在记录中包含唯一ID来检测重复。然后，如果它读取一个与早期记录具有相同ID的记录，它就知道它们是彼此的重复。GFS为处理这些情况的应用程序提供了一个库。

问：既然原子记录追加在文件中不可预测的偏移量写入，客户端如何找到它们的数据？

答：追加（以及GFS一般）主要适用于顺序读取整个文件的应用程序。这样的应用程序将扫描文件寻找有效记录（见前一个问题），所以它们不需要提前知道记录位置。例如，文件可能包含一组并发网络爬虫遇到的链接URL集。任何给定URL的文件偏移量并不重要；读者只希望能够读取整个URL集。

问：什么是校验和？

答：校验和算法接受一个字节块作为输入，并返回一个单一数字，该数字是所有输入字节的函数。例如，一个简单的校验和可能是输入中所有字节的总和（对某个大数取模）。GFS存储每个块的校验和以及块本身。当块服务器在其磁盘上写入一个块时，它首先计算新块的校验和，并将校验和与块一起保存在磁盘上。当块服务器从磁盘读取一个块时，它还读取先前保存的校验和，从磁盘读取的块重新计算校验和，并检查两个校验和是否匹配。如果数据被磁盘破坏，校验和将不匹配，块服务器将知道返回错误。另外，一些GFS应用程序在GFS文件内部存储自己的校验和，在应用程序定义的记录上，以区分正确记录和填充。CRC32是校验和算法的一个例子。

问：论文提到引用计数——它们是什么？

答：它们是快照写时复制实现的一部分。当GFS创建快照时，它不复制块，而是增加每个块的引用计数器。这使得创建快照很便宜。如果客户端写入一个块并且主服务器注意到引用计数大于一，主服务器首先制作一个副本，以便客户端可以更新副本（而不是作为快照一部分的块）。你可以将此视为延迟复制直到绝对必要。希望不是所有块都会被修改，可以避免制作一些副本。

问：如果应用程序使用标准POSIX文件API，是否需要修改才能使用GFS？

答：是的，但GFS不是为现有应用程序设计的。它是为新编写的应用程序设计的，如MapReduce程序。

问：GFS如何确定最近副本的位置？

答：论文暗示GFS基于存储可用副本的服务器的IP地址来做到这一点。在2003年，谷歌必须以一种方式分配IP地址，即如果两个IP地址在IP地址空间中彼此接近，那么它们在机房中也是彼此接近的。

问：假设S1是一个块的主服务器，主服务器和S1之间的网络故障。主服务器会注意到并指定某个其他服务器为主服务器，比如S2。由于S1实际上没有故障，现在同一个块是否有两个主服务器？

答：这将是一场灾难，因为两个主服务器可能对同一个块应用不同的更新。幸运的是，GFS的租约机制防止了这种情况。主服务器授予S1一个60秒的租约作为主服务器。S1知道在其租约到期时停止作为主服务器。主服务器不会授予S2租约，直到授予S1的前一个租约到期。所以S2不会在S1停止之前开始作为主服务器。

问：64兆字节听起来对于块大小来说很别扭地大！

答：64 MB块大小是主服务器中簿记的单位，也是文件在块服务器上分片的粒度。客户端可以发出更小的读写操作——它们不被迫处理整个64 MB的块。使用如此大的块大小的目的是减少主服务器中元数据表的大小，并避免限制想要进行巨大传输以减少开销的客户端。另一方面，小于64 MB的文件不会获得太多并行性。

问：谷歌还在使用GFS吗？

答：传言说GFS已被一种叫做Colossus的东西取代，具有相同的总体目标，但在主服务器性能和容错性方面有所改进。

问：GFS为了性能和简单性而牺牲正确性，这是多么可接受？

答：这是分布式系统中反复出现的主题。强一致性通常需要复杂的协议和机器之间的交谈（我们将在接下来的几讲中看到）。通过利用特定应用程序类别可以容忍放松一致性的方式，可以设计具有良好性能和足够一致性的系统。例如，GFS为MapReduce应用程序优化，这些应用程序需要大文件的高读取性能，并且可以容忍文件中的空洞、记录多次出现和不一致的读取。另一方面，GFS不适合存储银行的账户余额。

问：如果主服务器故障怎么办？

答：有具有主服务器状态完整副本的副本主服务器；论文的设计需要人工干预才能在主服务器故障后切换到其中一个副本（5.1.3节）。我们稍后将看到如何使用Raft构建具有自动切换到备份的副本服务。

问：为什么是3个副本？

答：这个数字被选择来最小化块丢失的概率。我想这是基于磁盘的可靠性和创建新副本所需的时间计算的。这是那个时代的磁盘可靠性研究：
https://research.google.com/archive/disk_failures.pdf。如果客户端希望文件被复制超过3次（例如，以允许更多并发读取），那么他们可以指定。

问：拥有单一主服务器被证明是个好主意吗？

答：这个想法简化了初始部署，但从长远来看并不那么好。这篇文章——https://queue.acm.org/detail.cfm?id=1594206——说，随着岁月流逝和GFS使用的增长，一些事情出了问题。文件数量增长到在一个单一主服务器的RAM中存储所有文件的元数据变得不合理。客户端数量增长到单一主服务器没有足够的CPU能力来服务它们。从故障主服务器切换到其备份之一需要人工干预使得恢复缓慢。显然，谷歌的GFS替代品Colossus将主服务器分布在多个服务器上，并且有更自动化的主服务器故障恢复。

问：什么是内部碎片？为什么延迟分配有帮助？

答：内部碎片是当系统使用比请求分配所需更大的分配单位时浪费的空间。例如，在GFS中，风险是应用程序创建一个1字节文件，浪费了64M-1字节，因为分配大小是64MB（一个块）。GFS避免了这个潜在问题，因为64MB是延迟分配的。每个块都是一个Linux文件，所以当应用程序创建1字节文件时，块的磁盘表示是1字节Linux文件。