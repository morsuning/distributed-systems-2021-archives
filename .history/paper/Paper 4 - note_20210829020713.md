# Raft 笔记

复制状态机
集群上的状态机计算相同状态的相同副本，即使某些服务器停机，也可以继续运行

用于解决分布式系统中的容错问题，特别是只有一个领导的大规模系统如 GFS，HDFS，RAMCloud。

复制状态机的例子包括 Zookeeper，Chabby

通常采用复制日志的方式实现

需要解决一致性问题

> 拜占庭条件 - 即存在错误的消息
> 一组拜占庭将军分别各率领一支军队共同围困一座城市。为了简化问题，将各支军队的行动策略限定为进攻或撤离两种。因为部分军队进攻部分军队撤离可能会造成灾难性后果，因此各位将军必须通过投票来达成一致策略，即所有军队一起进攻或所有军队一起撤离。因为各位将军分处城市不同方向，他们只能通过信使互相联系。在投票过程中每位将军都将自己投票给进攻还是撤退的信息通过信使分别通知其他所有将军，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以知道共同的投票结果而决定行动策略。
> 系统的问题在于，可能将军中出现叛徒，他们不仅可能向较为糟糕的策略投票，还可能选择性地发送投票信息。假设有9位将军投票，其中 1 名叛徒。8 名忠诚的将军中出现了 4 人投进攻，4人投撤离的情况。这时候叛徒可能故意给4名投进攻的将领送信表示投票进攻，而给4名投撤离的将领送信表示投撤离。这样一来在4名投进攻的将领看来，投票结果是5人投进攻，从而发起进攻；而在4名投撤离的将军看来则是5人投撤离。这样各支军队的一致协同就遭到了破坏。
> 由于将军之间需要通过信使通讯，叛变将军可能通过伪造信件来以其他将军的身份发送假投票。而即使在保证所有将军忠诚的情况下，也不能排除信使被敌人截杀，甚至被敌人间谍替换等情况。因此很难通过保证人员可靠性及通讯可靠性来解决问题。
> 假使那些忠诚（或是没有出错）的将军仍然能通过多数决定来决定他们的战略，便称达到了拜占庭容错。在此，票都会有一个默认值，若消息（票）没有被收到，则使用此默认值来投票。

Paxos 缺点

- 难于理解
- 没有为构建实现提供基础
- 体系结构缺点

Raft 协议

领导选举
复制日志
安全

基础

Raft 集群包含几个服务器，5 是经典值，允许系统容忍 2 次故障

Leader
Follower
Candidates

Raft 将时间划分为任意长度的项，每个任期(term)开始于一次选举，如果一名候选人赢得选举，它将在剩余任期内担任领导
**某些情况下选举造成分裂投票，在这种情况下，任期结束没有领导人**
任期在 Raft 中充当逻辑时钟，每个服务器存储一个当前任期编号，随时间增加。只要服务器通信，就要交换任期
**如果一台服务器的当前任期小于另一台服务器的任期，它就会将当前任期更换为更大的值**
如果一个候选人或领导者发现他的任期已经过期，他会立即回复到追随者状态
如果服务器收到一个带有过期任期编号的请求，它会拒绝该请求

Raft 使用两种 RPC

候选人在选举期间发起的请求投票 RPC
领导者发起的追加条目 RPC，后者用来复制日志和提供心跳

此外，还有用于在服务器之间传递快照的 RPC

当服务器启动时，它们开始成为追随者。只要服务器从领导者或候选人那里接收到有效的远程过程控制，它就保持在 Follower 状态。领导者定期向所有追随者发送心跳信号(不带日志条目的 AppendEntriesRPCs)，以维护他们的权威。如果一个跟随者在一段被称为选举超时的时间内没有收到任何通信，那么它就假设没有 可行的领导者，并开始选举来选择一个新的领导者。
要开始选举，追随者增加其当前任期，并过渡到候选人状态。然后，它为自己投票，并向集群中的每个其他服务器并行发出请求投票 RPC。候选人继续处于这种状态，直到发生三件事之一:(a)它赢得了选举，(b)另一个服务器确立了自己的领导地位，或 者(c)一段时间过去了，没有赢家。这些结果将在以下段落中单独讨论。
在等待投票时，候选人可能会从另一台声称是领导者的服务器上收到一个追加条目 RPC。如果领导者的任期(包含在其 RPC 中)至少与候选人当前的任期 一样长，那么候选人将认为领导者是合法的，并返回到追随者状态。如果 RPC 中的术语小于候选人的 当前术语，则候选人拒绝 RPC 并继续处于候选人状态。
第三种可能的结果是，一名候选人既不会赢得选举，也不会输掉选举:如果许多追随者同时成为候选人，选票可能会被分割，因此没有候选人获得多数票。当这种情况发生时，每个候选人都将超时，并 通过增加任期和启动另一轮请求投票 RPC 来开始新 的选举。然而，如果没有额外的措施，分裂的投票 可能会无限期地重复。
Raft 使用随机选举超时来确保分裂的投票很少，并 且很快得到解决。为了首先防止分裂投票，从固定间隔中随机选择选举超时(例如，。150–300 毫秒)。这 将服务器分散开来，因此在大多数情况下，只有一 台服务器会超时;它赢得选举，并在任何其他服务 器超时之前发送心跳。同样的机制被用来处理分裂 投票。每个候选人在选举开始时重新启动其随机选 举超时，并在开始下一次选举之前等待该超时过去; 这降低了新选举中再次出现分裂投票的可能性。第 9.3 节表明，这种方法可以快速选出领导人。
